<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pulumi Graph Viewer</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial, sans-serif; }
    #app { display: grid; grid-template-rows: 56px 1fr; height: 100%; }
    header { display: flex; align-items: center; gap: 12px; padding: 8px 12px; border-bottom: 1px solid #e5e7eb; }
    header h1 { font-size: 16px; margin: 0; font-weight: 600; }
    header .controls { margin-left: auto; display: flex; gap: 8px; }
    button { padding: 6px 10px; border-radius: 6px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; }
    button:hover { background: #f3f4f6; }
    .legend { font-size: 12px; color: #374151; }
    .content { display: grid; grid-template-columns: 1fr 360px; height: calc(100vh - 56px); }
    #cy { width: 100%; height: 100%; }
    #sidepanel { border-left: 1px solid #e5e7eb; padding: 12px; overflow: auto; background: #fafafa; }
    #sidepanel h2 { margin: 0 0 8px; font-size: 14px; }
    #sidepanel pre { background: #fff; border: 1px solid #e5e7eb; padding: 8px; border-radius: 6px; font-size: 12px; overflow: auto; }
    .muted { color: #6b7280; }
  </style>
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.umd.js"></script>
</head>
<body>
  <div id="app">
    <header>
      <h1>Pulumi Graph Viewer</h1>
      <div class="legend">Pass base64 JSON via #data=... in the URL</div>
      <div class="controls">
        <button id="fitBtn" title="Fit to screen">Fit</button>
        <button id="layoutBtn" title="Re-run layout">Layout</button>
        <button id="copyBtn" title="Copy raw JSON">Copy JSON</button>
      </div>
    </header>
    <div class="content">
      <div id="cy"></div>
      <aside id="sidepanel">
        <h2>Details</h2>
        <div id="details" class="muted">Click a node to see its properties.</div>
      </aside>
    </div>
  </div>

  <script>
    function toGraphElements(nodes) {
      const elements = [];
      // nodes
      nodes.forEach((n, i) => {
        const label = n.label || n.pulumiClass || String(i);
        const classes = (n.pulumiClass || '').replace(/\./g, ' ');
        elements.push({ data: { id: String(i), label, pulumiClass: n.pulumiClass || '' }, classes });
      });
      // edges from links
      nodes.forEach((n, i) => {
        const target = String(i);
        (n.links || []).forEach((l, idx) => {
          const source = String(l.nodeIndex);
          const id = `e-${i}-${idx}-${source}`;
          const label = l.prop || '';
          // Reverse direction: dependency -> dependent
          elements.push({ data: { id, source, target, label } });
        });
      });
      return elements;
    }

    function initCytoscape(elements) {
      const cy = cytoscape({
        container: document.getElementById('cy'),
        elements,
        style: [
          { selector: 'node', style: {
              'background-color': '#4f46e5',
              'label': 'data(label)',
              'color': '#111827',
              'text-background-color': '#e0e7ff',
              'text-background-opacity': 1,
              'text-background-shape': 'roundrectangle',
              'text-background-padding': '4px',
              'font-size': 10,
              'text-wrap': 'wrap',
              'text-max-width': 220,
              'padding': '8px',
              'shape': 'round-rectangle',
              'border-color': '#4338ca',
              'border-width': 1
          }},
          { selector: 'edge', style: {
              'curve-style': 'bezier',
              'target-arrow-shape': 'triangle',
              'target-arrow-color': '#9ca3af',
              'line-color': '#9ca3af',
              'width': 1.5,
              'label': 'data(label)',
              'font-size': 9,
              'text-background-color': '#f3f4f6',
              'text-background-opacity': 1,
              'text-background-padding': '2px',
              'text-rotation': 'autorotate'
          }}
        ],
        layout: { name: 'cose', animate: false }
      });
      return cy;
    }

    function renderDetails(nodeData, rawNode) {
      const el = document.getElementById('details');
      if (!rawNode) {
        el.innerHTML = '<span class="muted">Click a node to see its properties.</span>';
        return;
      }
      const safe = (o) => `<pre>${escapeHtml(JSON.stringify(o, null, 2))}</pre>`;
      el.innerHTML = `
        <div><strong>Label:</strong> ${escapeHtml(nodeData.label || '')}</div>
        <div><strong>Pulumi class:</strong> ${escapeHtml(nodeData.pulumiClass || '')}</div>
        <div style="margin-top:8px"><strong>Args:</strong></div>
        ${safe(rawNode.args)}
        <div style="margin-top:8px"><strong>Links:</strong></div>
        ${safe(rawNode.links || [])}
      `;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    async function run() {
      let data;
      try {
        const res = await fetch('/data', { cache: 'no-store' });
        data = await res.json();
      } catch (e) {
        document.getElementById('cy').innerHTML = '<div style="padding:16px;color:#b91c1c">Failed to fetch /data from local server.</div>';
        return;
      }

      const elements = toGraphElements(data);
      const cy = initCytoscape(elements);

      const layout = () => cy.layout({ name: 'cose', animate: false, fit: true }).run();
      layout();

      document.getElementById('fitBtn').onclick = () => cy.fit();
      document.getElementById('layoutBtn').onclick = () => layout();
      document.getElementById('copyBtn').onclick = async () => {
        try { await navigator.clipboard.writeText(JSON.stringify(data, null, 2)); } catch (e) {}
      };

      const indexToRaw = (i) => data[Number(i)];

      // Show default empty state
      renderDetails({}, null);

      cy.on('tap', 'node', (evt) => {
        const node = evt.target;
        const id = node.id();
        const raw = indexToRaw(id);
        renderDetails(node.data(), raw);
      });
    }

    run();
  </script>
</body>
</html>
